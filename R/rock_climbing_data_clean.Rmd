---
title: "Rock climbing survey data claning & t-test"
author: "Sunny Tseng"
date: "2023-03-05"
output: github_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

### Data description

There are 3 cohorts experienced rock climbing intervention. Surveys were done before intervention, after intervention, and 1-year after intervention (only for cohort 1). This research is aim to understand how the intervention would influence the behaviour of the participants. Cohort 1 includes 12 people, cohort 2 include 

And there were 20 questions asked, with 4 different levels: Strongly Agree, Agree, Disagree, Strongly Disagree. The goal of the analysi is to test whether there are differences between those levels before and after the intervention. 


### R packages & other functions

Here we install (by `install.packages()`) and load (by `library()`) the packages that we will need. A package is like a tool box in R, that includes many functions. For example, `tidyverse` package provides functions for data wrangling and data cleaning, `here` packages provides functions for working directory management.  

```{r, message = FALSE}
#install.packages("tidyverse")
#install.packages("here")
library(tidyverse)
library(readxl)
library(here)
library(knitr)
library(RColorBrewer)
```


## Cohort 1

### Import data

Use `read_excel` to import raw data. Note that the name of the folder and the file name were changed as there were parentheses `()` and commas `,` in the original name, which causes error when importing files into R. 

```{r, message = FALSE}
data_c1_s1 <- read_excel(here("data", 
                              "Cohort 1 Surveys_123_spreadsheets", 
                              "VIMFF Cohort 1 Survey 1_pre-intervention.xlsx"))

data_c1_s2 <- read_excel(here("data", 
                              "Cohort 1 Surveys_123_spreadsheets", 
                              "VIMFF Cohort 1 Survey 2_post-intervention.xlsx"))

data_c1_s3 <- read_excel(here("data", 
                              "Cohort 1 Surveys_123_spreadsheets", 
                              "VIMFF Cohort 1 Survey 3_post-post.xlsx"))

```


### Data cleaning

Cleaned column names, combined columns with multiple choice answers, changed the categorical answer into 1 - 4 for easier analysis. Only select columns that will need in the following analysis. 

For cohort 1, survey 1:
```{r}
new_name <- function(dataset, start, end){
  dataset[1, start:end] %>% as_vector()
}

data_c1_s1_clean <- data_c1_s1 %>%
  rename_with(.fn =~ new_name(data_c1_s1, 65, 84), .cols = c(65:84)) %>%
  filter(row_number() != 1) %>%
  unite(gender, names(.)[11:23], sep = ",", na.rm = TRUE) %>%
  unite(nationality, names(.)[12:28], sep = ",", na.rm = TRUE) %>%
  unite(indoor_style_practice, names(.)[24:26], sep = ",", na.rm = TRUE) %>%
  unite(outdoor_style_practice, names(.)[29:34], sep = ",", na.rm = TRUE) %>%
  mutate(cohort = "c1", survey = "s1") 

data_c1_s1_clean_1 <- data_c1_s1_clean %>%
  select("Respondent ID", "Collector ID", "indoor_style_practice",
         "outdoor_style_practice", 30:49, "cohort", "survey") 

#data_c1_s1_clean %>% str()
```

For cohort 1, survey 2:
```{r}
data_c1_s2_clean <- data_c1_s2 %>%
  rename_with(.fn =~ new_name(data_c1_s2, 32, 51), .cols = c(32:51)) %>%
  filter(row_number() != 1) %>%
  unite(indoor_style_practice, names(.)[19:21], sep = ",", na.rm = TRUE) %>%
  unite(outdoor_style_practice, names(.)[24:29], sep = ",", na.rm = TRUE) %>%
  mutate(cohort = "c1", survey = "s2") %>%
  select("Respondent ID", "Collector ID", "indoor_style_practice",
         "outdoor_style_practice", 25:44, "cohort", "survey") 

#data_c1_s2_clean %>% str()
```

For cohort 1, survey 3:
```{r}
data_c1_s3_clean <- data_c1_s3 %>%
  rename_with(.fn =~ new_name(data_c1_s3, 32, 51), .cols = c(32:51)) %>%
  filter(row_number() != 1) %>%
  unite(indoor_style_practice, names(.)[19:21], sep = ",", na.rm = TRUE) %>%
  unite(outdoor_style_practice, names(.)[24:29], sep = ",", na.rm = TRUE) %>%
  mutate(cohort = "c1", survey = "s3") %>%
  select("Respondent ID", "Collector ID", "indoor_style_practice",
         "outdoor_style_practice", 25:44, "cohort", "survey") 

#data_c1_s3_clean %>% str()
```

For cohort 1 (final summary). Noted that there are some mismatch between column names. Need to fix that before combining data frames. Here we only use before & after interventation for demonstration. We also cimpiled a dataframe to show individual participant information. 

```{r}
# s1 says "I find it difficult to find transportation to go outdoor climbing", while
# s2 says "I find it difficult to find transportation to outdoor climbing"
# There are many mis-match between s3 and s1&s2. Need check!

names(data_c1_s1_clean_1)[23] <- names(data_c1_s2_clean)[23] 
data_c1_clean <- rbind(data_c1_s1_clean_1, data_c1_s2_clean) %>%
    mutate_at(c(5:24), ~recode(., "Strongly Agree" = 4,
                             "Strongly agree" = 4,
                             "Agree" = 3,
                             "Disagree" = 2,
                             "Strongly Disagree" = 1,
                             "Strongly disagree" = 1),
            na.rm = TRUE) %>%
    mutate_at(c(5:24), ~recode(., "4" = "Strongly Agree",
                               "3" = "Agree",
                               "2" = "Disagree",
                               "1" = "Strongly Disagree")) %>%
    mutate_at(c(5:24), ~ factor(., levels = c("Strongly Disagree",
                                              "Disagree",
                                              "Agree",
                                              "Strongly Agree"))) 


data_c1_clean %>% str()
```

```{r}
data_c1_clean_individual <- data_c1_s1_clean %>%
  select("Respondent ID", "gender", "nationality", 13:18)

data_c1_clean_individual 
```


### Data visualization

Positive questions for climbing - before & after intervention

```{r}
nb.cols <- 20
mycolors <- colorRampPalette(brewer.pal(8, "Set2"))(nb.cols)

positive_c1 <- data_c1_clean %>%
  filter(cohort == "c1") %>%
  select(`Respondent ID`, survey, 5:8, 10:20) %>%
  pivot_longer(!c(`Respondent ID`, survey), 
               names_to = "question", 
               values_to = "Level of agreement") %>%
  mutate(survey = if_else(survey == "s1", "Before intervention", "After intervention")) %>%
  mutate(survey = factor(survey, levels = c("Before intervention", "After intervention"))) %>%
  drop_na() %>%
  ggplot() +
    geom_bar(aes(`Level of agreement`, fill = question)) + # position = position_dodge()
    scale_fill_manual(values = mycolors) +
    facet_grid(~survey) +
    theme(legend.position = "none") 

positive_c1

```


Negative questions for climbing - before & after intervention

```{r}
nb.cols <- 20
mycolors <- colorRampPalette(brewer.pal(8, "Set2"))(nb.cols)

negative_c1 <- data_c1_clean %>%
  filter(cohort == "c1") %>%
  select(`Respondent ID`, survey, 9, 21:24) %>%
  pivot_longer(!c(`Respondent ID`, survey), 
               names_to = "question", 
               values_to = "Level of agreement") %>%
  mutate(survey = if_else(survey == "s1", "Before intervention", "After intervention")) %>%
  mutate(survey = factor(survey, levels = c("Before intervention", "After intervention"))) %>%
  drop_na() %>%
  ggplot() +
    geom_bar(aes(`Level of agreement`, fill = question)) + # position = position_dodge()
    scale_fill_manual(values = mycolors) +
    facet_grid(~survey) +
    theme(legend.position = "bottom") 

negative_c1
```




Statistical test



### Questions for the dataset :) 
- Are the data of the 3 cohorts need to be pooled? Or each of them need to be compared seperately? 
- There are some NAs in the reply? 
- 










